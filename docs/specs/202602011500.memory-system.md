# Memory System — Simple, Human-Readable Agent Memory

**Status:** Implemented (Phase 1)

## Overview

A file-first, partitioned memory system using plain markdown files. Inspired by [Hindsight](https://github.com/vectorize-io/hindsight)'s world/experience separation, but optimized for simplicity and human-readability.

### Design Principles

- **Markdown-first**: All memory is plain text files you can read, edit, and version
- **Tools-only**: No automatic injection — agent decides when to read/write memory
- **Curation over automation**: Agents promote important learnings manually, not via ML pipelines

### Non-Goals (for now)

- Automatic context injection
- Sophisticated retrieval (BM25, embeddings, graph traversal)
- Automatic summarization or consolidation
- Entity extraction and resolution

## Directory Structure

```
.agnx/memory/
├── world/                       # Shared facts (all agents see)
│   ├── people.md
│   ├── systems.md
│   └── {topic}.md               # Grows organically by topic
└── agents/{agent-id}/
    ├── MEMORY.md                # Agent's curated long-term memory
    └── daily/
        └── YYYY-MM-DD.md        # Agent's daily experiences (append-only)
```

| Path | Owner | Purpose | Update Pattern |
|------|-------|---------|----------------|
| `world/*.md` | Shared | Objective facts about the world | Rewritten via `learn_fact` |
| `agents/{id}/MEMORY.md` | Agent | Agent's curated learnings | Rewritten via `reflect` |
| `agents/{id}/daily/*.md` | Agent | Daily experiences log | Append-only via `remember` |

## Tools

Four tools for memory operations — the agent decides when to use them:

| Tool | Action | When to use |
|------|--------|-------------|
| `recall` | Read memory context | Start of conversation, when context needed |
| `remember` | Append to daily log | After learning something |
| `reflect` | Rewrite MEMORY.md | End of session, consolidate learnings |
| `learn_fact` | Write world knowledge topic | New shared fact discovered |

### recall

Load memory context (world knowledge, agent memory, recent daily logs).

- **Parameters:** `days` (integer, default: 3)
- **Returns:** Concatenated content from `world/*.md`, `MEMORY.md`, and last N days of daily logs
- Sections separated by `---`

### remember

Append an experience to today's daily log.

- **Parameters:** `content` (string, required)
- **Behavior:** Appends timestamped entry to `agents/{id}/daily/YYYY-MM-DD.md`

### reflect

Rewrite the agent's long-term memory.

- **Parameters:** `content` (string, required)
- **Behavior:** Atomic write to `agents/{id}/MEMORY.md` (temp file + rename)

### learn_fact

Write shared world knowledge for a topic (replaces existing content).

- **Parameters:** `topic` (string, required), `content` (string, required)
- **Behavior:** Atomic write to `world/{topic}.md`
- Topic names are sanitized to lowercase alphanumeric + dashes

## Agent Configuration

```yaml
# agent.yaml
spec:
  memory:
    backend: filesystem               # default: filesystem (future: pluggable)
    workspace: .agnx/memory           # default: .agnx/memory

  tools:
    - type: builtin
      name: bash
    # Memory tools are automatically enabled when memory section is present
```

- If `memory:` section exists, all four memory tools are registered and a memory directive is added to the system prompt
- If `memory:` is absent, no memory tools or directives
- `workspace` relative paths are resolved from the agent config directory
- `backend` currently only supports "filesystem", but is included for future pluggability

### Memory Scoping

Agents sharing the same `workspace` share world knowledge but have separate `MEMORY.md` and daily logs (keyed by agent ID).

## Implementation

```
crates/agnx/src/
├── memory/
│   ├── mod.rs          # Memory struct, file operations
│   └── tools.rs        # RecallTool, RememberTool, ReflectTool, LearnFactTool
├── tools/
│   ├── factory.rs      # create_memory_tools() helper
│   └── memory.rs       # Re-exports from memory module
└── context/
    └── builder.rs      # DEFAULT_MEMORY_DIRECTIVE, with_memory_directive()
```

### Wiring

When a session starts, if `agent.memory` is configured:

1. `create_memory_tools(memory, agent_id)` creates all four tools
2. Tools are registered on the `ToolExecutor`
3. `ContextBuilder::with_memory_directive()` adds usage instructions to the system prompt

This wiring happens in `handlers/v1/sessions.rs`, `gateway/handler.rs`, and `scheduler/service.rs`.

### Durability

- **MEMORY.md / world files:** Atomic write (temp file + rename)
- **Daily files:** Append-only; partial writes result in incomplete entries (acceptable for logs)

## Growth Management

| File Type | Expected Size | Management |
|-----------|--------------|------------|
| `world/*.md` | 1-10 KB each | Agent rewrites during `learn_fact` |
| `MEMORY.md` | 2-10 KB | Agent rewrites during `reflect` |
| `daily/*.md` | 0.5-2 KB/day | Old files naturally become irrelevant |

For searching older memories beyond the `recall` window, use [fmd](https://github.com/giosakti/fmd) — a fast BM25F markdown search tool. This keeps agnx simple while providing search when needed.

## Future Enhancements

- **Pluggable backends:** `backend` field supports switching to SQLite, vector DB, etc.
- **`search_memory` tool:** Shell out to fmd from within agent
- **Temporal filtering:** Query by date range
- **Embeddings:** Semantic search as optional enhancement

## References

- [Hindsight](https://github.com/vectorize-io/hindsight) — World/experience separation
- [fmd](https://github.com/giosakti/fmd) — Fast markdown search
