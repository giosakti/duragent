# Agnx Deployment Plan

This document describes Agnx's deployment modes, storage configuration, and gateway setup.

## Deployment Philosophy

> **"For simple deployments, be self-contained with file-based state. For complex deployments, delegate state to external systems."**

Agnx follows a **stateless core with pluggable state** philosophy. The same binary can run in two modes:

### Simple Mode (Self-Hosted Power Users)

```
┌──────────────────────────────────────────────────────────────┐
│                    agnx serve                               │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐  │
│  │                  Gateway (embedded)                    │  │
│  │  Telegram ─┬─► Message Router ─► Agent Executor        │  │
│  │  Web      ─┤  (optional web transport; no bundled UI)   │  │
│  │  CLI      ─┘                                           │  │
│  └────────────────────────────────────────────────────────┘  │
│                            │                                 │
│  ┌────────────────────────────────────────────────────────┐  │
│  │                  File-Based State                      │  │
│  │                                                        │  │
│  │  ./.agnx/                                             │  │
│  │  ├── agents/my-agent/                                  │  │
│  │  │   ├── agent.yaml         # Structured agent config  │  │
│  │  │   ├── SYSTEM_PROMPT.md   # Unstructured prompt      │  │
│  │  │   └── INSTRUCTIONS.md    # Unstructured instructions│  │
│  │  ├── memory/                                           │  │
│  │  │   ├── 2025-01-10.md      # Yesterday                │  │
│  │  │   └── 2025-01-11.md      # Today                    │  │
│  │  ├── sessions/                                         │  │
│  │  │   └── session_abc.json   # Conversation history     │  │
│  │  └── artifacts/                                        │  │
│  │      └── generated_file.txt                            │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

**Key properties:**
- Zero external dependencies (single binary)
- All state is files (git-friendly, inspectable, editable)
- Memory is markdown files (human-readable)
- Gateway embedded for Telegram/CLI and optional web transport

### Complex Mode

```
┌─────────────────────────────────────────────────────────────┐
│                      External System                        │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                  Gateway Layer                        │  │
│  │  Telegram Webhook ─┬─► User Resolution                │  │
│  │  Web Controller   ─┤   (chat_id → user_id)            │  │
│  │  API              ─┘       │                          │  │
│  │                            ▼                          │  │
│  │                   Agent Config Lookup                 │  │
│  │                   (user_id → agent spec)              │  │
│  └────────────────────────────┬──────────────────────────┘  │
└───────────────────────────────┼─────────────────────────────┘
                                │ Agent Protocol API
                                ▼
┌─────────────────────────────────────────────────────────────┐
│              Agnx Worker Pool (Stateless)                  │
│                                                             │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                        │
│  │ Worker  │ │ Worker  │ │ Worker  │  (scale horizontally)  │
│  │   1     │ │   2     │ │   N     │                        │
│  └────┬────┘ └────┬────┘ └────┬────┘                        │
│       └───────────┴───────────┘                             │
│                   │                                         │
│  gateway.enabled: false  (Ext. sys handles routing)         │
│  services.*: external    (state in external services)       │
└───────────────────────────┬─────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   Memory     │    │   Session    │    │  Artifacts   │
│ (PostgreSQL) │    │ (PostgreSQL) │    │    (S3)      │
└──────────────┘    └──────────────┘    └──────────────┘
```

**Key properties:**
- Workers are stateless (can restart/scale anytime)
- State is in external services (PostgreSQL, S3)
- Gateway disabled (application handles routing)
- Agent configs passed per-request or cached

### Why This Philosophy Works

| Aspect | Simple Mode | Complex Mode |
|--------|-------------|--------------|
| **Dependencies** | Zero (single binary) | External services |
| **Scalability** | Single instance | Horizontal workers |
| **Data durability** | Files (git-friendly) | Database (ACID) |
| **Debugging** | Read files directly | Query services |
| **Migration** | Start simple → upgrade | Full control |

**Precedents:**
- **Files → External backends** — Same runtime, different state backend
- **Ollama** — Local by default, can connect to external
- **nginx** — Config files, stateless process

## Storage Modes

Agnx supports two state modes: **file-based (default)** and **external backends**.

### File-Based State (Default)

```yaml
# agnx.yaml - Simple Mode
data_dir: ./.agnx/

services:
  session:
    backend: filesystem
    path: ./.agnx/sessions/
  memory:
    backend: filesystem
    path: ./.agnx/memory/
  artifacts:
    backend: filesystem
    path: ./.agnx/artifacts/
```

**Memory format (file mode):**
```markdown
# 2025-12-15

## Decisions Made
- Chose Telegram as primary interface
- Named the agent "Socrates"

## Preferences Learned
- User prefers bullet points
- Timezone: Asia/Jakarta

## Facts Stored
- User's blog: example.com
- Current project: agnx
```

### External Mode

```yaml
# agnx.yaml - Complex Mode
services:
  memory:
    backend: postgres
    url: ${DATABASE_URL}

  session:
    backend: postgres
    url: ${DATABASE_URL}

  artifacts:
    backend: s3
    bucket: my-artifacts
    region: us-east-1
```

### Storage Interface

Agnx keeps state concerns separate so deployments can mix-and-match backends (e.g., Postgres for sessions, File-based for memory, S3 for artifacts).

In code, this maps to three small traits instead of a single storage backend:

```rust
#[async_trait]
pub trait MemoryStore: Send + Sync {
    async fn put(&self, agent_id: &str, entry: MemoryEntry) -> Result<()>;
    async fn query(&self, agent_id: &str, q: MemoryQuery) -> Result<Vec<MemoryEntry>>;
    async fn export(&self, agent_id: &str) -> Result<Box<dyn AsyncRead + Send>>; // portable export
}

#[async_trait]
pub trait SessionStore: Send + Sync {
    // Sessions are append-only event logs (better for durability and concurrency).
    async fn append(&self, session_id: &str, event: SessionEvent) -> Result<()>;
    async fn read(&self, session_id: &str, opts: SessionReadOptions) -> Result<Vec<SessionEvent>>;
    async fn delete(&self, session_id: &str) -> Result<()>;
}

#[async_trait]
pub trait ArtifactStore: Send + Sync {
    async fn put(&self, agent_id: &str, name: &str, data: Box<dyn AsyncRead + Send>, meta: ArtifactMeta) -> Result<ArtifactRef>;
    async fn get(&self, artifact_ref: &ArtifactRef) -> Result<Box<dyn AsyncRead + Send>>;
    async fn list(&self, agent_id: &str, prefix: &str, limit: usize) -> Result<Vec<ArtifactRef>>;
}

pub struct ArtifactRef {
    pub id: String,   // stable identifier (or path for filesystem backends)
    pub name: String,
    pub url: Option<String>, // optional (S3/GCS); None for local filesystem
    pub meta: ArtifactMeta,
}
```

### Switching Modes

Users can start with file mode and upgrade to external mode without changing agent definitions:

```yaml
# Start simple (filesystem)
services:
  memory: { backend: filesystem, path: ./.agnx/memory/ }
  session: { backend: filesystem, path: ./.agnx/sessions/ }
  artifact: { backend: filesystem, path: ./.agnx/artifacts/ }

# Later, upgrade (example: postgres memory)
services:
  memory: { backend: postgres, url: ${DATABASE_URL} }
```

## Gateway Configuration

### Embedded Gateway (Simple Mode)

For self-hosted power users, the gateway is built into Agnx:

```yaml
# agnx.yaml
gateway:
  enabled: true

  telegram:
    enabled: true
    token: ${TELEGRAM_BOT_TOKEN}

  web:
    enabled: true
    port: 8081

  # Future providers
  whatsapp:
    enabled: false
  discord:
    enabled: false
```

**How it works:**
1. Gateway receives message from Telegram/Web/CLI
2. Routes to the single configured agent (no user resolution needed)
3. Agent processes, returns response
4. Gateway sends response back through same channel

### External Gateway (Complex Mode)

For SaaS deployments, the application owns the gateway:

```yaml
# agnx.yaml
gateway:
  enabled: false  # Application handles this
```

**How it works:**
1. Application (e.g., Rails) receives webhook from Telegram
2. Application identifies user from `chat_id`
3. Application looks up user's agent configuration
4. Application calls Agnx worker via Agent Protocol API
5. Application sends response back to user

This separation allows:
- Application to handle authentication, billing, analytics
- Agnx workers to remain stateless and scalable
- Different gateway implementations per deployment

## Provider Configuration

```yaml
# agnx.yaml
gateway:
  enabled: true

  providers:
    telegram:
      enabled: true
      token: ${TELEGRAM_BOT_TOKEN}
      # Optional: webhook mode for production
      webhook:
        enabled: false
        url: https://example.com/webhook/telegram

    web:
      enabled: true
      port: 8081
      # Optional: authentication
      auth:
        enabled: false
        token: ${WEB_AUTH_TOKEN}

    cli:
      enabled: true  # Always available when running interactively
```

## Quick Start Examples

### Minimal Self-Hosted Setup

```bash
# 1. Create a file-based state directory (portable)
mkdir -p ./.agnx/agents/my-assistant/skills

# 2. Create unstructured files
cat > ./.agnx/agents/my-assistant/SYSTEM_PROMPT.md << 'EOF'
You are a helpful assistant.
EOF

cat > ./.agnx/agents/my-assistant/INSTRUCTIONS.md << 'EOF'
Keep responses concise and actionable.
EOF

# 3. Create agent definition
cat > ./.agnx/agents/my-assistant/agent.yaml << 'EOF'
apiVersion: agnx/v1alpha1
kind: Agent
metadata:
  name: my-assistant
spec:
  model: openrouter/anthropic/claude-sonnet-4
  system_prompt: ./SYSTEM_PROMPT.md
  instructions: ./INSTRUCTIONS.md
EOF

# (Optional) Add skills under ./.agnx/agents/my-assistant/skills/ and Agnx will discover them by default.

# 4. Run Agnx
export OPENROUTER_API_KEY=your-key
agnx serve --agents-dir ./.agnx/agents/

# 5. Chat via CLI
agnx chat --agent-dir ./.agnx/agents/my-assistant/
```
