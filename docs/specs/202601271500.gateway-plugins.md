# Gateway Plugins

## What is this?

Platform gateway system enabling Agnx to communicate with messaging platforms (Telegram, WhatsApp, Discord). Supports both built-in gateways (compiled in) and external gateways (subprocess).

## The Problem

Agnx core provides CLI, HTTP, and SSE interfaces, but users want to interact with agents via messaging platforms. Each platform has different APIs, authentication flows, and message formats. We need a unified gateway architecture that's simple for self-hosters yet flexible for production deployments.

## User Scenarios

### Scenario 1: Self-host with Telegram

1. User installs `agnx` (default build includes Telegram)
2. User adds `TELEGRAM_BOT_TOKEN` to config
3. User runs `agnx serve` — Telegram bot starts automatically
4. Messages to the bot are routed to configured agent

### Scenario 2: Production with Crash Isolation

1. User builds `agnx --no-default-features` (minimal core)
2. User runs Telegram gateway as separate process
3. Gateway crashes don't affect Agnx core
4. Agnx restarts gateway automatically per restart policy

### Scenario 3: Custom Gateway

1. Developer writes gateway in Python/Go/Node
2. Gateway implements Gateway Protocol (JSON over stdio)
3. User configures external gateway in `agnx.yaml`
4. Agnx spawns and supervises the custom gateway

## Core Features

- **Gateway Protocol**: JSON-over-stdio communication between Agnx and gateways
- **Built-in Gateways**: Telegram (default), WhatsApp/Discord (optional features)
- **External Gateways**: Subprocess plugins in any language
- **Gateway Manager**: Unified interface abstracting built-in vs subprocess
- **Process Supervision**: Restart policies, health checks, graceful shutdown

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    agnx (single binary)                          │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  Gateway Manager                             │ │
│  │   Abstracts built-in (channels) vs external (JSON/stdio)    │ │
│  └──────────────────────────┬──────────────────────────────────┘ │
│                             │                                    │
│    ┌────────────────────────┼────────────────────────────────┐   │
│    │ Built-in (feature flags)                                │   │
│    │  [telegram]  [discord]  [whatsapp]                      │   │
│    └────────────────────────┼────────────────────────────────┘   │
│                             │                                    │
└─────────────────────────────┼────────────────────────────────────┘
                              │ JSON/stdio
                    ┌─────────┴─────────┐
                    │ External Gateways │
                    │ (any language)    │
                    └───────────────────┘
```

## Gateway Protocol (v1)

### Commands (Agnx → Gateway)

| Command | Purpose |
|---------|---------|
| `send_message` | Send text to chat |
| `send_media` | Send image/video/document |
| `send_typing` | Show typing indicator |
| `edit_message` | Edit sent message |
| `ping` | Health check |
| `shutdown` | Graceful termination |

### Events (Gateway → Agnx)

| Event | Purpose |
|-------|---------|
| `ready` | Gateway initialized, capabilities declared |
| `message_received` | Incoming user message |
| `command_ok` | Command succeeded |
| `command_error` | Command failed |
| `auth_required` | QR code needed (WhatsApp) |
| `shutdown` | Gateway terminating |

## Repo Structure

```
agnx/
├── Cargo.toml              # Workspace root
├── agnx/                   # Main binary
├── agnx-core/              # Shared types (protocol, config)
└── gateways/
    └── telegram/
        ├── Cargo.toml      # lib + bin targets
        └── src/
            ├── lib.rs      # Core logic (both modes)
            └── main.rs     # Subprocess entry point
```

Same gateway code compiles as library (built-in) or binary (subprocess).

## Acceptance Criteria

- [ ] Gateway Protocol spec implemented in `agnx-core`
- [ ] Gateway Manager handles both built-in and subprocess uniformly
- [ ] Telegram gateway works in built-in mode (default feature)
- [ ] Telegram gateway works as subprocess (same crate, binary target)
- [ ] Subprocess gateways die when Agnx dies (no orphans)
- [ ] Subprocess restart policy configurable (on-failure, max attempts, backoff)
- [ ] Feature flags control binary size (`--no-default-features` excludes gateways)

## Out of Scope

- WhatsApp gateway implementation (future milestone)
- Discord/Slack gateways (future milestone)
- Webhook mode for Telegram (long polling first)
- Gateway hot-reload without restart

## Technical Notes

- Use `prctl(PR_SET_PDEATHSIG)` on Linux for subprocess cleanup
- Cross-platform: detect stdin EOF as parent death signal
- Subprocess communication: JSON Lines (newline-delimited JSON) over stdio
- Built-in communication: Rust mpsc channels (no serialization)
