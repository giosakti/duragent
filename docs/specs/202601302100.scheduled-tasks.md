# Scheduled Tasks

## What is this?

Runtime scheduling that lets agents create time-based triggers to send messages to users via any gateway (Telegram, Discord, etc.).

## The Problem

Agents can't proactively reach out to users. All interactions are user-initiated. This blocks use cases like:
- "Remind me to check deployment status tomorrow at 9am"
- "Send me a daily standup prompt on weekdays"
- "Follow up on this issue in 2 hours"

## User Scenarios

### Scenario 1: One-time reminder
1. User: "Remind me to review the PR in 2 hours"
2. Agent calls `schedule_task` tool with `at: "2026-01-30T16:00:00Z"`
3. Two hours later, user receives message in Telegram: "Reminder: review the PR"

### Scenario 2: Recurring prompt
1. User: "Send me a daily standup prompt at 9am on weekdays"
2. Agent calls `schedule_task` with `cron: "0 9 * * MON-FRI"`
3. Every weekday at 9am, user receives: "Good morning! What's on your agenda today?"
4. User replies, conversation continues naturally

### Scenario 3: Message during active conversation
1. User is chatting with agent in Telegram
2. Scheduled task fires
3. Message appears in same conversation (not a new thread)
4. User's reply continues the existing session

## Core Features

- **`schedule_task` tool**: Agents create schedules at runtime (one-shot or cron)
- **In-process scheduler**: Tokio-based, persisted to `.duragent/schedules/`
- **Gateway delivery**: Scheduled messages route through any configured gateway
- **Session continuity**: Injects into active session if one exists, otherwise creates fresh

## Acceptance Criteria

- [ ] Agent can create one-shot schedules (`at` timestamp) via tool
- [ ] Agent can create recurring schedules (`cron` syntax) via tool
- [ ] Schedules persist to disk and survive restarts
- [ ] Scheduled messages deliver to specified gateway/chat
- [ ] Messages inject into active session when one exists for that (chat, agent) pair
- [ ] Agent can list and cancel its own scheduled tasks

## Out of Scope

- Multi-node distributed scheduling (future: Redis/Postgres backend)
- User approval workflow for schedules
- Rate limiting / abuse prevention
- Static schedules in agent.yaml (triggers section)

## Technical Notes

Schedule storage format:
```yaml
# .duragent/schedules/{schedule_id}.yaml
id: reminder-abc123
agent: my-assistant
created_by_session: session_xyz
destination:
  gateway: telegram
  chat_id: "123456789"
schedule:
  at: "2026-01-30T16:00:00Z"    # one-shot
  # or: cron: "0 9 * * MON-FRI" # recurring
payload:
  message: "Reminder: review the PR"
```

Session routing rule: one active session per `(chat_id, agent)` tuple.
