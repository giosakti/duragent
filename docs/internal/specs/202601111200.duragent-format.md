# Duragent Format Specification

## Overview

The Duragent Format defines a portable, human-readable specification for AI agents. It draws inspiration from:

- **[AGENTS.md](https://agents.md/)** — Simple markdown for coding agents (OpenAI/Linux Foundation)
- **[Claude Code Skills](https://code.claude.com/docs/en/skills)** — Skill.md with frontmatter and bundled resources
- **[Open Agent Specification](https://arxiv.org/abs/2510.04173v3)** — Declarative agent workflows (Oracle)
- **[A2A Protocol](https://a2a-protocol.org/)** — Agent Card for discovery (Google/Linux Foundation)
- **[Pi-mono/Clawdbot](https://docs.clawd.bot/concepts/agent)** — Bootstrap files pattern (AGENTS.md, SOUL.md, etc.)
- **Kubernetes manifests** — apiVersion/kind/metadata/spec pattern

## Design Principles

1. **Human-readable** — YAML/Markdown, editable in any text editor
2. **Portable** — Works across runtimes, not tied to Duragent
3. **Progressive** — Simple agents are simple; complex agents are possible
4. **Composable** — Skills, tools, and memory are modular
5. **Git-friendly** — Text files, easy to version and diff
6. **Context-efficient** — Minimal system prompts; load context on demand
7. **File-first storage** — Default to files for state; external backends for scale

## Deployment Context

Duragent Format agents are designed to work in two deployment modes:

### Self-Hosted (File-Based State)

For power users running Duragent locally, agents and runtime states are stored as files under `./.duragent/`.

In this mode we assume **a single local user**; `./.duragent/{memory,sessions}` are user-owned stores (not nested under a specific agent). Sessions may reference which agent produced them.

```
~/duragent-workspace/
└── ./.duragent/                           # File-based state root (portable)
    ├── agents/
    │   └── my-agent/
    │       ├── agent.yaml              # Agent definition
    │       ├── SOUL.md                 # Agent personality (optional)
    │       ├── SYSTEM_PROMPT.md        # Agent system prompt (optional)
    │       ├── INSTRUCTIONS.md         # Agent behavior instructions (optional)
    │       ├── skills/                 # Skills directory
    │       │   └── task-extraction/
    │       │       └── SKILL.md
    │       └── tools/                  # CLI tools for this agent
    │           └── my-tool.sh
    ├── sessions/                       # User sessions (reference agent + channel)
    │   └── session_abc/
    │       ├── events.jsonl            # Append-only event log
    │       └── state.yaml              # Snapshot for fast resume
    └── memory/                         # User memory store
```

**Benefits:**
- Everything is visible, editable, git-versioned
- No database setup required
- Agent + memory are portable as a single folder

**Note:** By convention, Duragent's file-based state root is `./.duragent/` (relative to the current working directory). For simple self-hosted usage, you typically run Duragent from a workspace directory and keep all durable state under `./.duragent/`.

### SaaS (External State)

For managed services, the agent definition is the same, but state is stored externally:

```yaml
services:
  session:   { backend: postgres, url: ${DATABASE_URL} }
  memory:    { backend: postgres, url: ${DATABASE_URL} }
```

**Benefits:**
- Multi-tenant scalability
- ACID guarantees
- Centralized backup/restore
- Same agent definition works in both modes

## Agent Definition

### Minimal Agent

```yaml
# agent.yaml
apiVersion: duragent/v1alpha1
kind: Agent
metadata:
  name: simple-assistant
spec:
  model:
    provider: openrouter
    name: anthropic/claude-sonnet-4
  system_prompt: ./SYSTEM_PROMPT.md
```

### Full Agent

```yaml
# agent.yaml
apiVersion: duragent/v1alpha1
kind: Agent
metadata:
  name: productivity-assistant
  description: Personal productivity assistant with task management
  version: 1.0.0
  labels:
    domain: productivity
    tier: premium

spec:
  model:
    provider: openrouter
    name: anthropic/claude-sonnet-4
    temperature: 0.7
    max_output_tokens: 4096

  # Agent personality and communication style (optional).
  soul: ./SOUL.md

  # Loaded into every turn of the conversation (optional).
  system_prompt: ./SYSTEM_PROMPT.md

  # Detailed behavioral rules/playbooks (optional).
  instructions: ./INSTRUCTIONS.md

  # Session behavior
  session:
    on_disconnect: continue       # or: pause (default)
    max_tool_iterations: 10       # default: 10
    ttl_hours: 48                 # per-agent TTL override (optional)
    compaction: archive           # per-agent compaction override (optional)
    context:
      max_history_tokens: 20000   # default: 20000 (0 = no cap)
      max_tool_result_tokens: 8000 # default: 8000

  # Access control (optional, gateway-only)
  access:
    dm:
      policy: open                # open | disabled | allowlist
    groups:
      policy: allowlist           # open | disabled | allowlist
      allowlist: ["telegram:-100123456"]
      sender_default: silent       # allow | passive | silent | block
      sender_overrides:
        "67890": allow
        "99999": block
      activation: mention          # mention (default) | always
      context_buffer:
        mode: silent               # silent (default) | passive
        max_messages: 100
        max_age_hours: 24
      queue:
        mode: batch                # batch (default) | sequential | drop
        max_pending: 10
        overflow: drop_old         # drop_old (default) | drop_new | reject
        debounce:
          enabled: true
          window_ms: 1500

  # Memory (optional)
  memory:
    backend: filesystem            # default: filesystem

  tools:
    # Built-in tools
    - type: builtin
      name: bash                           # Execute shell commands

    # CLI tools (custom scripts)
    - type: cli
      name: git-helper
      command: ./tools/git-helper/script.sh
      description: Run git operations      # optional
      readme: ./tools/git-helper/README.md # optional

  # Skills directory (scanned for SKILL.md files)
  skills_dir: ./skills/
```

## Spec Fields Reference

### metadata

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Unique identifier (alphanumeric, hyphens) |
| `description` | string | No | Human-readable description |
| `version` | string | No | Semantic version |
| `labels` | map | No | Key-value labels for filtering (e.g. `domain: productivity`, `tier: premium`) |

### spec.model

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `provider` | string | Yes | LLM provider (openrouter, openai, anthropic, ollama) |
| `name` | string | Yes | Model name/identifier |
| `temperature` | float | No | Sampling temperature (0-2, default 0.7) |
| `max_input_tokens` | int | No | Optional hint for Duragent-side input truncation before calling the provider |
| `max_output_tokens` | int | No | Max response tokens (output/completion tokens) |
| `base_url` | string | No | Override model provider's base URL |

### spec.soul

Path to a markdown file defining the agent's personality and communication style. Injected into context alongside system_prompt.

**Example SOUL.md:**
```markdown
Communication style rules:
- Be concise and concrete; prefer bullet points over paragraphs
- Ask one clarifying question when requirements are ambiguous
- Avoid hype and filler; explain tradeoffs plainly
- Match the user's tone; only use emojis if the user uses them first
```

### spec.system_prompt

Path to a markdown file defining the agent's identity and role. Loaded into every turn of a session.

**Best practice:** Keep this minimal. Put detailed behavioral rules in `INSTRUCTIONS.md` and put large, situational context into skills loaded only when needed.

### spec.instructions

Path to a markdown file defining detailed behavioral instructions (the agent's "playbook"): operating rules, policies, step-by-step workflows, output formats, and refusal boundaries.

Template variables use `{{var}}` syntax (Handlebars-style, to avoid ambiguity with `${ENV_VAR}` used in config YAML). Unknown variables are left as-is.

Supported variables:
- `{{date}}` — Current date (ISO 8601, e.g. `2026-02-16`)
- `{{time}}` — Current time (HH:MM UTC, e.g. `14:30 UTC`)
- `{{agent.name}}` — Agent metadata name
- `{{agent.home}}` — Agent directory path

### spec.session

Session behavior configuration. Sessions follow tmux-like semantics: **disconnection does not stop the session**.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `on_disconnect` | string | No | Behavior when client disconnects: `continue` or `pause` (default: `pause`) |
| `max_tool_iterations` | int | No | Maximum tool call iterations per request (default: 10) |
| `ttl_hours` | int | No | Per-agent TTL override (hours). Overrides global `sessions.ttl_hours`. |
| `compaction` | string | No | Per-agent compaction mode override: `discard`, `archive`, `disabled`. Overrides global `sessions.compaction`. |
| `context` | object | No | Context window management settings (see `spec.session.context` below) |

**Disconnect modes:**

| Mode | Behavior | Use Case |
|------|----------|----------|
| `continue` | Agent keeps executing, buffers output | Async workflows, supervisor agents |
| `pause` | Agent pauses at next safe point, waits for reconnect | Interactive chat |

**Example — Interactive assistant (pauses on disconnect):**
```yaml
session:
  on_disconnect: pause
```

**Example — Autonomous supervisor (continues on disconnect):**
```yaml
session:
  on_disconnect: continue
```

#### spec.session.context

Context window management configuration. Controls how conversation history and tool results are truncated to fit within the model's context window. All fields have sensible defaults — the entire `context` block can be omitted.

```yaml
session:
  context:
    max_history_tokens: 20000       # Cap history tokens to reserve budget for tool work (0 = no cap)
    max_tool_result_tokens: 8000    # Per-result token cap
    tool_result_truncation: head    # head, tail, or both
    tool_result_keep_first: 2       # First N tool results kept visible
    tool_result_keep_last: 5        # Last M tool results kept visible
```

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `max_history_tokens` | int | `20000` | Max tokens for conversation history in each LLM call. Reserves remaining budget for tool work during agentic loops. `0` = no cap. |
| `max_tool_result_tokens` | int | `8000` | Max tokens per individual tool result. Must be > 0. |
| `tool_result_truncation` | string | `head` | How to truncate oversized tool results: `head` (keep beginning), `tail` (keep end), or `both` (keep beginning + end, 50/50 split). |
| `tool_result_keep_first` | int | `2` | First N tool results kept visible during agentic loops (older results in the middle are masked). |
| `tool_result_keep_last` | int | `5` | Last M tool results kept visible during agentic loops. Both `0` = masking disabled. |

Token estimation uses a `bytes / 4` heuristic with a 10% safety margin. See the [Context Window Management spec](./202602081000.context-window-management.md) for the full three-layer truncation design.

### spec.access

Access control configuration. Controls who can interact with the agent via gateways (Telegram, Discord, etc.). Does not affect HTTP API or CLI access.

When omitted, the agent accepts all messages (open access).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `dm` | object | No | DM (direct message) access policy |
| `groups` | object | No | Group/channel access policy |

**`dm` fields:**

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `policy` | string | `open` | `open` (accept all), `disabled` (reject all), or `allowlist` (sender IDs only) |
| `allowlist` | list | `[]` | Sender IDs allowed when policy is `allowlist`. Supports trailing `*` wildcards (e.g. `user_*`). |

**`groups` fields:**

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `policy` | string | `open` | `open` (accept all), `disabled` (reject all), or `allowlist` (composite keys only) |
| `allowlist` | list | `[]` | `{channel}:{chat_id}` composite keys allowed when policy is `allowlist` (e.g. `telegram:-100123456`, `discord:1234567890`). Supports trailing `*` wildcards (e.g. `telegram:*` for all Telegram groups, `*` for all groups). |
| `sender_default` | string | `allow` | Default sender disposition within allowed groups |
| `sender_overrides` | map | `{}` | Per-sender disposition overrides (sender ID → disposition). Supports trailing `*` wildcards (e.g. `admin_*`); exact matches take priority. |
| `activation` | string | `mention` | `mention` (respond only when @mentioned or replied to) or `always` (respond to every allowed message) |
| `context_buffer` | object | see below | Configuration for non-triggering messages in mention mode |
| `queue` | object | see below | Queue configuration for handling concurrent messages |

**Sender dispositions (groups only):**

| Disposition | LLM sees it? | Triggers response? | Stored in session? | Use case |
|-------------|-------------|-------------------|-------------------|----------|
| `allow` | Yes | Yes | Yes (UserMessage) | Normal interaction |
| `passive` | Yes (future turns) | No | Yes (UserMessage) | Context without triggering |
| `silent` | No | No | Yes (SilentMessage) | Audit trail only |
| `block` | No | No | No | Spam, bad actors |

Disposition resolution: check `sender_overrides` for exact sender ID match first, then wildcard pattern match, then fall back to `sender_default`.

**Activation modes:**

| Mode | Behavior |
|------|----------|
| `mention` | Only respond when @mentioned or replied to. Non-triggering messages from `allow` senders go to the context buffer. |
| `always` | Respond to every allowed message (no mention required). |

**`context_buffer` fields:**

Controls how non-triggering messages from `allow` senders are handled in `mention` mode.

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `mode` | string | `silent` | `silent` (ephemeral buffer, injected as system block on trigger) or `passive` (stored as UserMessage in conversation history) |
| `max_messages` | int | `100` | Maximum number of recent messages to inject (silent mode only) |
| `max_age_hours` | int | `24` | Maximum age in hours for buffer messages (silent mode only) |

**Context buffer modes:**

| Mode | Storage | LLM sees it? | Survives crash? | Token cost |
|------|---------|-------------|----------------|------------|
| `silent` | SilentMessage (ephemeral) | Only when triggered (injected as system block) | No | Low (only on trigger) |
| `passive` | UserMessage (conversation history) | Yes (every turn) | Yes | Accumulates over time |

**`queue` fields:**

Controls how concurrent messages are handled when the session is busy processing.

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `mode` | string | `batch` | `batch` (combine all pending into one), `sequential` (process one at a time), or `drop` (discard pending) |
| `max_pending` | int | `10` | Maximum number of messages waiting in the queue |
| `overflow` | string | `drop_old` | What happens when queue is full: `drop_old`, `drop_new`, or `reject` |
| `reject_message` | string | none | Message sent to the user when their message is rejected (only used with `reject` overflow) |
| `debounce` | object | see below | Per-sender debounce settings |

**Queue modes:**

| Mode | Behavior | Use case |
|------|----------|----------|
| `batch` | After processing completes, combine all pending messages into one and process it | Rapid message senders, group conversations |
| `sequential` | After processing completes, take the next pending message and process it (repeats until empty) | Preserve individual context per message |
| `drop` | After processing completes, discard all pending messages | Simple, predictable behavior |

**Overflow strategies:**

| Strategy | Behavior |
|----------|----------|
| `drop_old` | Evict the oldest pending message to make room for the new one |
| `drop_new` | Silently discard the new message |
| `reject` | Discard the new message and send `reject_message` back to the user |

**`debounce` fields:**

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `enabled` | bool | `true` | Whether per-sender debouncing is enabled |
| `window_ms` | int | `1500` | Idle window in milliseconds before flushing buffered messages |

**Example — Restricted agent with group sender control:**
```yaml
access:
  dm:
    policy: allowlist
    allowlist: ["12345"]
  groups:
    policy: allowlist
    allowlist: ["telegram:-100123456"]
    sender_default: passive
    sender_overrides:
      "67890": allow
      "99999": block
    activation: mention
    context_buffer:
      mode: silent
      max_messages: 50
      max_age_hours: 12
    queue:
      mode: sequential
      max_pending: 5
      overflow: reject
      reject_message: "I'm busy, please wait."
```

### spec.memory

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `backend` | string | No | Memory backend (`filesystem` by default) |

**Filesystem convention (file-based mode):**
- Use date-based Markdown files under `${duragent.data_dir}/memory/` (e.g. `YYYY-MM-DD.md`) for durable continuity notes.
- This keeps memory transparent, editable, and easy to export.

### spec.tools

List of tool definitions. Supports two types:

**Tool Types:**

| Type | Description |
|------|-------------|
| `builtin` | Built-in Duragent tools (e.g., `bash`) |
| `cli` | CLI tool with optional README |

**CLI Tool Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `type` | string | Yes | `cli` |
| `name` | string | Yes | Tool identifier |
| `command` | string | Yes | CLI command or script path (relative to agent dir) |
| `description` | string | No | Short description shown to LLM |
| `readme` | string | No | Path to README (agent reads on-demand) |

**Why CLI tools?**
- More token-efficient than MCP (no upfront schema dump)
- Agent reads README only when it needs the tool
- Simpler to create (just a script + README)
- Progressive disclosure pattern

**Built-in Tool Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `type` | string | Yes | `builtin` |
| `name` | string | Yes | Tool identifier (e.g., `bash`) |

**Available built-in tools:**

| Name | Description |
|------|-------------|
| `bash` | Execute shell commands in sandbox |

### spec.skills_dir

Directory containing local skills for this agent.

- Default: `./skills/` (relative to the agent directory)
- If set, Duragent will scan that directory for skill packages (each containing `SKILL.md`).

Skill IDs are derived from:
- `SKILL.md` frontmatter `name` if present, otherwise
- the skill directory name.

## Skills

Skills are reusable behaviors that can be bundled with agents or shared independently.

Duragent adopts the [Agent Skills](https://agentskills.io) open standard as the base format for skill definitions, ensuring portability across ecosystems (Claude Code, Cursor, Codex, Gemini CLI, and 20+ other tools).

**Key pattern:** Skills teach the agent how to use tools without writing code. Drop a markdown file with instructions and examples into the skills directory.

### Skill Directory Structure

```
skills/
└── task-extraction/
    ├── SKILL.md              # Required: Skill definition
    ├── scripts/
    │   └── extract.py        # Optional: Executable scripts
    ├── references/
    │   └── examples.md       # Optional: Loaded into context
    └── assets/
        └── template.txt      # Optional: Templates
```

### SKILL.md Format

Follows the [Agent Skills specification](https://agentskills.io/specification):

- YAML frontmatter between `---` delimiters
- Required fields: `name`, `description`
- Optional fields: `allowed-tools` (space-delimited string), `metadata` (key-value map)
- Name must be lowercase + hyphens only, ≤64 chars, and match the directory name
- Body content (after frontmatter) contains instructions, examples, and output format

**Example:**

```markdown
---
name: task-extraction
description: Extract actionable tasks from a message or conversation
allowed-tools: calculator
metadata:
  version: "1.0.0"
  author: Duragent
---

## Instructions

1. Find explicit action items and implied commitments.
2. Present tasks in a consistent JSON shape.
```

Full example: `../examples/skills/task-extraction`

## Examples

### Example 1: Simple Q&A Bot

```yaml
apiVersion: duragent/v1alpha1
kind: Agent
metadata:
  name: qa-bot
spec:
  model:
    provider: openrouter
    name: anthropic/claude-sonnet-4
  system_prompt: ./SYSTEM_PROMPT.md
```

### Example 2: Code Review Agent

```yaml
apiVersion: duragent/v1alpha1
kind: Agent
metadata:
  name: code-reviewer
spec:
  model:
    provider: openrouter
    name: anthropic/claude-sonnet-4
    temperature: 0.3
  system_prompt: ./SYSTEM_PROMPT.md
  instructions: ./INSTRUCTIONS.md
  session:
    on_disconnect: pause  # Interactive review sessions
  tools:
    - type: builtin
      name: bash
    - type: cli
      name: git-diff
      command: ./tools/git-diff.sh
      description: Show git diff for review
```

### Example 3: Personal Assistant

```yaml
apiVersion: duragent/v1alpha1
kind: Agent
metadata:
  name: personal-assistant
spec:
  model:
    provider: openrouter
    name: anthropic/claude-sonnet-4
  soul: ./SOUL.md
  system_prompt: ./SYSTEM_PROMPT.md
  instructions: ./INSTRUCTIONS.md
  session:
    on_disconnect: pause  # Interactive assistant
    max_tool_iterations: 15
  tools:
    - type: builtin
      name: bash
    - type: cli
      name: notes
      command: ./tools/notes.sh
      description: Manage personal notes
```

### Example 4: Autonomous Code Supervisor

```yaml
apiVersion: duragent/v1alpha1
kind: Agent
metadata:
  name: code-supervisor
  description: Completes coding tasks autonomously
spec:
  model:
    provider: anthropic
    name: claude-sonnet-4-20250514
  system_prompt: ./SYSTEM_PROMPT.md
  session:
    on_disconnect: continue  # Keeps working after user disconnects
    max_tool_iterations: 50
  tools:
    - type: builtin
      name: bash
    - type: cli
      name: git-pr
      command: ./tools/git-pr.sh
      description: Create GitHub pull requests
```

## Versioning

The format uses semantic versioning-like API versions:
- `duragent/v1alpha1` — Alpha version (breaking changes allowed)
- `duragent/v1beta1` — Beta version (mostly stable; minor breakage still possible)
- `duragent/v1` — Stable version
- `duragent/v2` — Future breaking changes

Duragent runtime will support multiple versions and provide migration tools.

## References

### Standards
- [AGENTS.md Specification](https://agents.md/)
- [A2A Protocol Specification](https://a2a-protocol.org/) — Agent-to-Agent protocol (Linux Foundation)
- [Open Agent Specification](https://arxiv.org/abs/2510.04173v3)
- [Model Context Protocol](https://modelcontextprotocol.io/)
- [Agent Protocol](https://agentprotocol.ai/)

### Format Inspiration
- [Claude Code Skills](https://code.claude.com/docs/en/skills) — Skill.md format
- [Google ADK](https://google.github.io/adk-docs/) — Agent Development Kit
- [Pi-mono](https://github.com/badlogic/pi-mono) — Minimal agent toolkit
