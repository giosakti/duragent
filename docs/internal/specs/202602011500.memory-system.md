# Memory System — Simple, Human-Readable Agent Memory

**Status:** Implemented (Phase 1)

## Overview

A file-first, partitioned memory system using plain markdown files. Inspired by [Hindsight](https://github.com/vectorize-io/hindsight)'s world/experience separation, but optimized for simplicity and human-readability.

### Design Principles

- **Markdown-first**: All memory is plain text files you can read, edit, and version
- **Tools-only**: No automatic injection — agent decides when to read/write memory
- **Curation over automation**: Agents promote important learnings manually, not via ML pipelines

### Non-Goals (for now)

- Automatic context injection
- Sophisticated retrieval (BM25, embeddings, graph traversal)
- Automatic summarization or consolidation
- Entity extraction and resolution

## Directory Structure

```
{workspace}/                     # default: .duragent (resolved relative to config file)
├── memory/
│   └── world/                   # Shared facts (all agents see)
│       ├── people.md
│       ├── systems.md
│       └── {topic}.md           # Grows organically by topic
└── agents/
    └── {agent-name}/            # Agent directory
        ├── agent.yaml
        └── memory/              # Agent-specific, local
            ├── MEMORY.md        # Agent's curated long-term memory
            └── daily/
                └── YYYY-MM-DD.md  # Agent's daily experiences (append-only)
```

| Path | Owner | Purpose | Update Pattern |
|------|-------|---------|----------------|
| `{workspace}/memory/world/*.md` | Shared | Objective facts about the world | Rewritten via `update_world` |
| `{workspace}/agents/{name}/memory/MEMORY.md` | Agent | Agent's curated learnings | Rewritten via `reflect` |
| `{workspace}/agents/{name}/memory/daily/*.md` | Agent | Daily experiences log | Append-only via `remember` |

## Tools

Four tools for memory operations — the agent decides when to use them:

| Tool | Action | When to use |
|------|--------|-------------|
| `recall` | Read memory context | Start of conversation, when context needed |
| `remember` | Append to daily log | After learning something |
| `reflect` | Rewrite MEMORY.md | End of session, consolidate learnings |
| `update_world` | Write world knowledge topic | New shared fact discovered |

### recall

Load memory context (world knowledge, agent memory, recent daily logs).

- **Parameters:** `days` (integer, default: 3)
- **Returns:** Concatenated content from `world/*.md`, `MEMORY.md`, and last N days of daily logs
- Sections separated by `---`

### remember

Append an experience to today's daily log.

- **Parameters:** `content` (string, required)
- **Behavior:** Appends timestamped entry to `{agent_dir}/memory/daily/YYYY-MM-DD.md`

### reflect

Rewrite the agent's long-term memory.

- **Parameters:** `content` (string, required)
- **Behavior:** Atomic write to `{agent_dir}/memory/MEMORY.md` (temp file + rename)

### update_world

Write shared world knowledge for a topic (replaces existing content).

- **Parameters:** `topic` (string, required), `content` (string, required)
- **Behavior:** Atomic write to `world/{topic}.md`
- Topic names are sanitized to lowercase alphanumeric + dashes

## Configuration

### Global Config (`duragent.yaml`)

```yaml
workspace: .duragent              # default: .duragent (resolved relative to config file)

# Optional overrides (when omitted, derived from workspace):
#   world_memory.path → {workspace}/memory/world
# world_memory:
#   path: custom/memory/world
```

### Agent Config (`agent.yaml`)

```yaml
spec:
  memory:
    backend: filesystem   # default: filesystem (enables all 4 memory tools)

  tools:
    - type: builtin
      name: bash
    # Memory tools are automatically enabled when memory section is present
```

- If `memory:` section exists in agent config, all four memory tools are registered
- If `memory:` is absent, no memory tools are registered
- Directives are always loaded from `{workspace}/directives/` and `{agent_dir}/directives/` regardless of memory config
- The global `world_memory.path` provides the shared world knowledge directory for all agents
- `backend` currently only supports "filesystem", but is included for future pluggability

### Memory Scoping

All agents share the same world knowledge directory configured in `duragent.yaml`. Agent-specific memory (`MEMORY.md` and daily logs) lives in `{agent_dir}/memory/`, co-located with the agent's configuration.

## Implementation

```
crates/duragent/src/
├── memory/
│   ├── mod.rs          # Memory struct, file operations, DEFAULT_MEMORY_DIRECTIVE
│   └── tools.rs        # RecallTool, RememberTool, ReflectTool, UpdateWorldTool
├── tools/
│   ├── factory.rs      # create_memory_tools() helper
│   └── memory.rs       # Re-exports from memory module
└── context/
    ├── directives.rs   # File-based directive loading from workspace + agent dirs
    └── builder.rs      # with_directives()
```

### Directives

Directives are `*.md` files loaded from two directories:
- `{workspace}/directives/` — workspace-level, shared across all agents (scope: Global)
- `{agent_dir}/directives/` — agent-level, per-agent (scope: Agent)

Both levels are always concatenated (workspace first, then agent). Files are sorted by filename within each directory. Empty files are skipped.

When any agent has `memory` configured, `{workspace}/directives/memory.md` is auto-created at startup with the default memory directive content. Users can edit it afterward.

### Wiring

When a session starts:

1. `load_all_directives()` reads `*.md` files from workspace and agent directive directories
2. `ContextBuilder::with_directives()` adds them to the system prompt
3. If `agent.memory` is configured, `create_memory_tools(memory)` creates all four tools and they are registered on the `ToolExecutor`

This wiring happens in `handlers/v1/sessions.rs`, `gateway/handler.rs`, and `scheduler/service.rs`.

### Durability

- **MEMORY.md / world files:** Atomic write (temp file + rename)
- **Daily files:** Append-only; partial writes result in incomplete entries (acceptable for logs)

## Growth Management

| File Type | Expected Size | Management |
|-----------|--------------|------------|
| `world/*.md` | 1-10 KB each | Agent rewrites during `update_world` |
| `MEMORY.md` | 2-10 KB | Agent rewrites during `reflect` |
| `daily/*.md` | 0.5-2 KB/day | Old files naturally become irrelevant |

For searching older memories beyond the `recall` window, use [fmd](https://github.com/giosakti/fmd) — a fast BM25F markdown search tool. This keeps duragent simple while providing search when needed.

## Future Enhancements

- **Pluggable backends:** `backend` field supports switching to SQLite, vector DB, etc.
- **`search_memory` tool:** Shell out to fmd from within agent
- **Temporal filtering:** Query by date range
- **Embeddings:** Semantic search as optional enhancement

## References

- [Hindsight](https://github.com/vectorize-io/hindsight) — World/experience separation
- [fmd](https://github.com/giosakti/fmd) — Fast markdown search
